name: Deploy para Servidor

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NAMESPACE: producao
      KUBECTL_VERSION: v1.28.0

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configurar SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -x
          mkdir -p ~/.ssh

          # Cria a chave privada
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Corrige falhas do ssh-keyscan
          ssh-keyscan -T 5 -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Testa conexão
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "echo 'Conexao SSH estabelecida!'"

      - name: Deploy no servidor
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            echo 'Iniciando deploy no servidor...'
            cd /home/azureuser/projeto-k8s
            git pull
            kubectl apply -f deployment.yaml -n ${NAMESPACE}
            kubectl apply -f service.yaml -n ${NAMESPACE}
            echo 'Deploy finalizado com sucesso!'
          "

      - name: Sucesso
        run: echo "Deploy concluído com sucesso!"

